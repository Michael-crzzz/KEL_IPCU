@model IPCU.Models.PatientDevicesViewModel
@{
    ViewData["Title"] = "Patient Devices";
}

<div class="container-fluid">
    <h2>Connected Devices</h2>
    <div class="row mb-3">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h4>@Model.Patient.PatientName</h4>
                    <p class="mb-0">
                        <small>
                            <strong>Hospital Number:</strong> @Model.Patient.HospNum |
                            <strong>Location:</strong> @Model.Patient.AdmLocation |
                            <strong>Room:</strong> @Model.Patient.RoomID
                        </small>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-3">
        <div class="col-md-12">
            <a asp-action="AddConnectedDevice" asp-route-id="@Model.Patient.IdNum" class="btn btn-primary">
                <i class="fas fa-plus me-1"></i> Add Device
            </a>
            <a asp-action="Details" asp-route-id="@Model.Patient.IdNum" class="btn btn-secondary">
                Back to Patient Details
            </a>
        </div>
    </div>

    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h5>Current and Previous Devices</h5>
                </div>
                <div class="card-body">
                    @if (Model.ConnectedDevices == null || !Model.ConnectedDevices.Any())
                    {
                            <p class="alert alert-info">No devices have been recorded for this patient.</p>
                    }
                    else
                    {
                            <div class="table-responsive">
                                <table class="table table-striped table-hover">
                                    <thead>
                                        <tr>
                                            <th>Device Type</th>
                                            <th>Insertion Date</th>
                                            <th>Removal Date</th>
                                            <th>Duration (days)</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                    @foreach (var device in Model.ConnectedDevices)
                                    {
                                        var duration = device.DeviceRemove.HasValue
                                            ? (device.DeviceRemove.Value - device.DeviceInsert).Days
                                            : (DateTime.Now - device.DeviceInsert).Days;

                                        var status = device.DeviceRemove.HasValue ? "Removed" : "Active";
                                        var statusClass = device.DeviceRemove.HasValue ? "badge bg-secondary" : "badge bg-success";

                                                <tr>
                                                    <td>@device.DeviceType</td>
                                                    <td>@device.DeviceInsert.ToShortDateString()</td>
                                                    <td>
                                                @(device.DeviceRemove.HasValue ? device.DeviceRemove.Value.ToShortDateString() : "-")
                                                    </td>
                                                    <td>@duration</td>
                                                    <td>
                                                        <span class="@statusClass">@status</span>
                                                    </td>
                                                    <td>
                                                @if (!device.DeviceRemove.HasValue)
                                                {
                                                                <a asp-action="UpdateConnectedDevice" 
                                                                   asp-route-id="@Model.Patient.IdNum" 
                                                                   asp-route-deviceId="@device.DeviceId" 
                                                                   class="btn btn-sm btn-warning">
                                                                    <i class="fas fa-edit me-1"></i> Update
                                                                </a>
                                                }
                                                    </td>
                                                </tr>
                                    }
                                    </tbody>
                                </table>
                            </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>