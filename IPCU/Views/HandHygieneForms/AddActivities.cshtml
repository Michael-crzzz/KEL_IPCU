@model IPCU.Models.HHActivity
@{
    ViewData["Title"] = "Add Hand Hygiene Activities";
}
<h2>Add Activities</h2>
@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success">
        @TempData["SuccessMessage"]
    </div>
}
<div class="row">
    <div class="col-md-8">
        <form asp-action="AddActivities" asp-controller="HandHygieneForms" method="post">
            <input type="hidden" name="HHId" value="@ViewBag.HHId" />
            <div class="form-group mb-3">
                <label for="Activity" class="form-label">Activity</label>
                <input type="text" id="Activity" name="Activity" class="form-control" required />
                @if (ViewData.ModelState["Activity"]?.Errors.Count > 0)
                {
                    <span class="text-danger">@ViewData.ModelState["Activity"].Errors.First().ErrorMessage</span>
                }
            </div>

            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Hand Hygiene Activities</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <!-- Before Activity Section -->
                        <div class="col-md-6">
                            <h6 class="mb-3 border-bottom pb-2">Before Activity</h6>

                            <!-- Before Hand Type Toggle -->
                            <div class="btn-group mb-3 w-100" role="group" aria-label="Before hand hygiene type">
                                <input type="radio" class="btn-check" name="beforeHandType" id="beforeHandRubToggle" autocomplete="off" checked>
                                <label class="btn btn-outline-primary" for="beforeHandRubToggle">Hand Rub</label>

                                <input type="radio" class="btn-check" name="beforeHandType" id="beforeHandWashToggle" autocomplete="off">
                                <label class="btn btn-outline-primary" for="beforeHandWashToggle">Hand Wash</label>
                            </div>

                            <!-- Before Hand Rub -->
                            <div class="mb-3 before-hand-type" id="beforeHandRubSection">
                                <label class="form-label">Before Hand Rub</label>

                                <div class="d-flex flex-column gap-3 mt-2">
                                    <div class="border p-2 rounded">
                                        <div class="fw-bold mb-1">1. Before touching a patient</div>
                                        <div class="btn-group" role="group">
                                            <input type="radio" class="btn-check" name="BeforeHandRub1Symbol" id="BeforeHandRub1Check" value="1">
                                            <label class="btn btn-outline-success" for="BeforeHandRub1Check">✓</label>

                                            <input type="radio" class="btn-check" name="BeforeHandRub1Symbol" id="BeforeHandRub1Cross" value="0">
                                            <label class="btn btn-outline-danger" for="BeforeHandRub1Cross">X</label>

                                            <input type="radio" class="btn-check" name="BeforeHandRub1Symbol" id="BeforeHandRub1None" value="" checked>
                                            <label class="btn btn-outline-secondary" for="BeforeHandRub1None">None</label>
                                        </div>
                                    </div>

                                    <div class="border p-2 rounded">
                                        <div class="fw-bold mb-1">2. Before clean/aseptic procedure</div>
                                        <div class="btn-group" role="group">
                                            <input type="radio" class="btn-check" name="BeforeHandRub2Symbol" id="BeforeHandRub2Check" value="1">
                                            <label class="btn btn-outline-success" for="BeforeHandRub2Check">✓</label>

                                            <input type="radio" class="btn-check" name="BeforeHandRub2Symbol" id="BeforeHandRub2Cross" value="0">
                                            <label class="btn btn-outline-danger" for="BeforeHandRub2Cross">X</label>

                                            <input type="radio" class="btn-check" name="BeforeHandRub2Symbol" id="BeforeHandRub2None" value="" checked>
                                            <label class="btn btn-outline-secondary" for="BeforeHandRub2None">None</label>
                                        </div>
                                    </div>
                                </div>
                                <input type="hidden" id="BeforeHandRub" name="BeforeHandRub" />
                            </div>

                            <!-- Before Hand Wash -->
                            <div class="mb-3 before-hand-type d-none" id="beforeHandWashSection">
                                <label class="form-label">Before Hand Wash</label>

                                <div class="d-flex flex-column gap-3 mt-2">
                                    <div class="border p-2 rounded">
                                        <div class="fw-bold mb-1">1. Before touching a patient</div>
                                        <div class="btn-group" role="group">
                                            <input type="radio" class="btn-check" name="BeforeHandWash1Symbol" id="BeforeHandWash1Check" value="1">
                                            <label class="btn btn-outline-success" for="BeforeHandWash1Check">✓</label>

                                            <input type="radio" class="btn-check" name="BeforeHandWash1Symbol" id="BeforeHandWash1Cross" value="0">
                                            <label class="btn btn-outline-danger" for="BeforeHandWash1Cross">X</label>

                                            <input type="radio" class="btn-check" name="BeforeHandWash1Symbol" id="BeforeHandWash1None" value="" checked>
                                            <label class="btn btn-outline-secondary" for="BeforeHandWash1None">None</label>
                                        </div>
                                    </div>

                                    <div class="border p-2 rounded">
                                        <div class="fw-bold mb-1">2. Before clean/aseptic procedure</div>
                                        <div class="btn-group" role="group">
                                            <input type="radio" class="btn-check" name="BeforeHandWash2Symbol" id="BeforeHandWash2Check" value="1">
                                            <label class="btn btn-outline-success" for="BeforeHandWash2Check">✓</label>

                                            <input type="radio" class="btn-check" name="BeforeHandWash2Symbol" id="BeforeHandWash2Cross" value="0">
                                            <label class="btn btn-outline-danger" for="BeforeHandWash2Cross">X</label>

                                            <input type="radio" class="btn-check" name="BeforeHandWash2Symbol" id="BeforeHandWash2None" value="" checked>
                                            <label class="btn btn-outline-secondary" for="BeforeHandWash2None">None</label>
                                        </div>
                                    </div>
                                </div>
                                <input type="hidden" id="BeforeHandWash" name="BeforeHandWash" />
                            </div>
                        </div>

                        <!-- After Activity Section -->
                        <div class="col-md-6">
                            <h6 class="mb-3 border-bottom pb-2">After Activity</h6>

                            <!-- After Hand Type Toggle -->
                            <div class="btn-group mb-3 w-100" role="group" aria-label="After hand hygiene type">
                                <input type="radio" class="btn-check" name="afterHandType" id="afterHandRubToggle" autocomplete="off" checked>
                                <label class="btn btn-outline-primary" for="afterHandRubToggle">Hand Rub</label>

                                <input type="radio" class="btn-check" name="afterHandType" id="afterHandWashToggle" autocomplete="off">
                                <label class="btn btn-outline-primary" for="afterHandWashToggle">Hand Wash</label>
                            </div>

                            <!-- After Hand Rub -->
                            <div class="mb-3 after-hand-type" id="afterHandRubSection">
                                <label class="form-label">After Hand Rub</label>

                                <div class="d-flex flex-column gap-3 mt-2">
                                    <div class="border p-2 rounded">
                                        <div class="fw-bold mb-1">3. After body fluid exposure risk</div>
                                        <div class="btn-group" role="group">
                                            <input type="radio" class="btn-check" name="AfterHandRub3Symbol" id="AfterHandRub3Check" value="1">
                                            <label class="btn btn-outline-success" for="AfterHandRub3Check">✓</label>

                                            <input type="radio" class="btn-check" name="AfterHandRub3Symbol" id="AfterHandRub3Cross" value="0">
                                            <label class="btn btn-outline-danger" for="AfterHandRub3Cross">X</label>

                                            <input type="radio" class="btn-check" name="AfterHandRub3Symbol" id="AfterHandRub3None" value="" checked>
                                            <label class="btn btn-outline-secondary" for="AfterHandRub3None">None</label>
                                        </div>
                                    </div>

                                    <div class="border p-2 rounded">
                                        <div class="fw-bold mb-1">4. After touching a patient</div>
                                        <div class="btn-group" role="group">
                                            <input type="radio" class="btn-check" name="AfterHandRub4Symbol" id="AfterHandRub4Check" value="1">
                                            <label class="btn btn-outline-success" for="AfterHandRub4Check">✓</label>

                                            <input type="radio" class="btn-check" name="AfterHandRub4Symbol" id="AfterHandRub4Cross" value="0">
                                            <label class="btn btn-outline-danger" for="AfterHandRub4Cross">X</label>

                                            <input type="radio" class="btn-check" name="AfterHandRub4Symbol" id="AfterHandRub4None" value="" checked>
                                            <label class="btn btn-outline-secondary" for="AfterHandRub4None">None</label>
                                        </div>
                                    </div>

                                    <div class="border p-2 rounded">
                                        <div class="fw-bold mb-1">5. After touching patient surroundings</div>
                                        <div class="btn-group" role="group">
                                            <input type="radio" class="btn-check" name="AfterHandRub5Symbol" id="AfterHandRub5Check" value="1">
                                            <label class="btn btn-outline-success" for="AfterHandRub5Check">✓</label>

                                            <input type="radio" class="btn-check" name="AfterHandRub5Symbol" id="AfterHandRub5Cross" value="0">
                                            <label class="btn btn-outline-danger" for="AfterHandRub5Cross">X</label>

                                            <input type="radio" class="btn-check" name="AfterHandRub5Symbol" id="AfterHandRub5None" value="" checked>
                                            <label class="btn btn-outline-secondary" for="AfterHandRub5None">None</label>
                                        </div>
                                    </div>

                                </div>
                                <input type="hidden" id="AfterHandRub" name="AfterHandRub" />
                            </div>

                            <!-- After Hand Wash -->
                            <div class="mb-3 after-hand-type d-none" id="afterHandWashSection">
                                <label class="form-label">After Hand Wash</label>

                                <div class="d-flex flex-column gap-3 mt-2">
                                    <div class="border p-2 rounded">
                                        <div class="fw-bold mb-1">3. After body fluid exposure risk</div>
                                        <div class="btn-group" role="group">
                                            <input type="radio" class="btn-check" name="AfterHandWash3Symbol" id="AfterHandWash3Check" value="1">
                                            <label class="btn btn-outline-success" for="AfterHandWash3Check">✓</label>

                                            <input type="radio" class="btn-check" name="AfterHandWash3Symbol" id="AfterHandWash3Cross" value="0">
                                            <label class="btn btn-outline-danger" for="AfterHandWash3Cross">X</label>

                                            <input type="radio" class="btn-check" name="AfterHandWash3Symbol" id="AfterHandWash3None" value="" checked>
                                            <label class="btn btn-outline-secondary" for="AfterHandWash3None">None</label>
                                        </div>
                                    </div>

                                    <div class="border p-2 rounded">
                                        <div class="fw-bold mb-1">4. After touching a patient</div>
                                        <div class="btn-group" role="group">
                                            <input type="radio" class="btn-check" name="AfterHandWash4Symbol" id="AfterHandWash4Check" value="1">
                                            <label class="btn btn-outline-success" for="AfterHandWash4Check">✓</label>

                                            <input type="radio" class="btn-check" name="AfterHandWash4Symbol" id="AfterHandWash4Cross" value="0">
                                            <label class="btn btn-outline-danger" for="AfterHandWash4Cross">X</label>

                                            <input type="radio" class="btn-check" name="AfterHandWash4Symbol" id="AfterHandWash4None" value="" checked>
                                            <label class="btn btn-outline-secondary" for="AfterHandWash4None">None</label>
                                        </div>
                                    </div>

                                    <div class="border p-2 rounded">
                                        <div class="fw-bold mb-1">5. After touching patient surroundings</div>
                                        <div class="btn-group" role="group">
                                            <input type="radio" class="btn-check" name="AfterHandWash5Symbol" id="AfterHandWash5Check" value="1">
                                            <label class="btn btn-outline-success" for="AfterHandWash5Check">✓</label>

                                            <input type="radio" class="btn-check" name="AfterHandWash5Symbol" id="AfterHandWash5Cross" value="0">
                                            <label class="btn btn-outline-danger" for="AfterHandWash5Cross">X</label>

                                            <input type="radio" class="btn-check" name="AfterHandWash5Symbol" id="AfterHandWash5None" value="" checked>
                                            <label class="btn btn-outline-secondary" for="AfterHandWash5None">None</label>
                                        </div>
                                    </div>

                                </div>
                                <input type="hidden" id="AfterHandWash" name="AfterHandWash" />
                            </div>
                        </div>
                    </div>

                    <div class="form-check mb-3 mt-3">
                        <input class="form-check-input" type="checkbox" id="Gloves" name="Gloves" value="True" />
                        <label class="form-check-label" for="Gloves">Gloves Used?</label>
                    </div>
                </div>
            </div>

            <div class="form-group mt-3">
                <button type="submit" class="btn btn-primary">Add Activity</button>
                <a asp-action="FinishActivities" asp-route-id="@ViewBag.HHId" class="btn btn-success">Finish</a>
            </div>
        </form>
    </div>
    <div class="col-md-4">
        @if (ViewBag.Activities != null && ((List<HHActivity>)ViewBag.Activities).Any())
        {
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Activities Added</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm table-striped">
                            <thead>
                                <tr>
                                    <th>Activity</th>
                                    <th>Before HR</th>
                                    <th>Before HW</th>
                                    <th>After HR</th>
                                    <th>After HW</th>
                                    <th>Gloves</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var item in (List<HHActivity>)ViewBag.Activities)
                                {
                                    <tr>
                                        <td>@item.Activity</td>
                                        <td>@Html.Raw(FormatHygieneData(item.BeforeHandRub))</td>
                                        <td>@Html.Raw(FormatHygieneData(item.BeforeHandWash))</td>
                                        <td>@Html.Raw(FormatHygieneData(item.AfterHandRub))</td>
                                        <td>@Html.Raw(FormatHygieneData(item.AfterHandWash))</td>
                                        <td>@(item.Gloves == "True" ? "Yes" : "No")</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        }
        else
        {
            <div class="alert alert-info">
                <h5>No activities added yet</h5>
                <p>Use the form to add hand hygiene activities.</p>
            </div>
        }
    </div>
</div>

@functions {
    public string FormatHygieneData(string data)
    {
        if (string.IsNullOrEmpty(data))
            return "";

        var result = "";
        var items = data.Split(';');

        foreach (var item in items)
        {
            if (!string.IsNullOrEmpty(item))
            {
                var parts = item.Split(',');
                if (parts.Length == 2)
                {
                    string moment = "";
                    switch (parts[0])
                    {
                        case "1":
                            moment = "Before patient";
                            break;
                        case "2":
                            moment = "Before procedure";
                            break;
                        case "3":
                            moment = "After fluids";
                            break;
                        case "4":
                            moment = "After patient";
                            break;
                        case "5":
                            moment = "After surroundings";
                            break;
                        default:
                            moment = parts[0];
                            break;
                    }

                    // Convert numerical value to symbol
                    string symbol = parts[1] == "1" ? "✓" : "X";
                    string bgClass = parts[1] == "1" ? "bg-success" : "bg-danger";

                    result += $"<span class='badge {bgClass}'>{moment}: {symbol}</span> ";
                }
            }
        }

        return result;
    }
}

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
    <script>
        $(document).ready(function() {
            // Toggle between hand rub and hand wash sections
            $("#beforeHandRubToggle").change(function() {
                if ($(this).is(":checked")) {
                    $("#beforeHandRubSection").removeClass("d-none");
                    $("#beforeHandWashSection").addClass("d-none");
                }
            });

            $("#beforeHandWashToggle").change(function() {
                if ($(this).is(":checked")) {
                    $("#beforeHandWashSection").removeClass("d-none");
                    $("#beforeHandRubSection").addClass("d-none");
                }
            });

            $("#afterHandRubToggle").change(function() {
                if ($(this).is(":checked")) {
                    $("#afterHandRubSection").removeClass("d-none");
                    $("#afterHandWashSection").addClass("d-none");
                }
            });

            $("#afterHandWashToggle").change(function() {
                if ($(this).is(":checked")) {
                    $("#afterHandWashSection").removeClass("d-none");
                    $("#afterHandRubSection").addClass("d-none");
                }
            });

            // Function to update hidden inputs from symbol selections
            function updateHiddenInputs() {
                // For BeforeHandRub
                const beforeRubValues = [];
                for (let i = 1; i <= 2; i++) {
                    const symbol = $(`input[name="BeforeHandRub${i}Symbol"]:checked`).val();
                    if (symbol) {
                        beforeRubValues.push(`${i},${symbol}`);
                    }
                }
                $('#BeforeHandRub').val(beforeRubValues.join(';'));

                // For BeforeHandWash
                const beforeWashValues = [];
                for (let i = 1; i <= 2; i++) {
                    const symbol = $(`input[name="BeforeHandWash${i}Symbol"]:checked`).val();
                    if (symbol) {
                        beforeWashValues.push(`${i},${symbol}`);
                    }
                }
                $('#BeforeHandWash').val(beforeWashValues.join(';'));

                // For AfterHandRub
                const afterRubValues = [];
                for (let i = 3; i <= 5; i++) {
                    const symbol = $(`input[name="AfterHandRub${i}Symbol"]:checked`).val();
                    if (symbol) {
                        afterRubValues.push(`${i},${symbol}`);
                    }
                }
                $('#AfterHandRub').val(afterRubValues.join(';'));

                // For AfterHandWash
                const afterWashValues = [];
                for (let i = 3; i <= 5; i++) {
                    const symbol = $(`input[name="AfterHandWash${i}Symbol"]:checked`).val();
                    if (symbol) {
                        afterWashValues.push(`${i},${symbol}`);
                    }
                }
                $('#AfterHandWash').val(afterWashValues.join(';'));
            }

            // Add event listeners for all radio buttons
            $('input[type="radio"]').change(updateHiddenInputs);

            // Initial update
            updateHiddenInputs();

            // Form submission validation
            $('form').submit(function(e) {
                // Get the visible sections based on toggle selections
                const isBeforeHandRubVisible = $("#beforeHandRubToggle").is(":checked");
                const isAfterHandRubVisible = $("#afterHandRubToggle").is(":checked");

                // Check for symbols in the visible sections
                let hasSymbol = false;

                if (isBeforeHandRubVisible) {
                    hasSymbol = hasSymbol || $('#BeforeHandRub').val().length > 0;
                } else {
                    hasSymbol = hasSymbol || $('#BeforeHandWash').val().length > 0;
                }

                if (isAfterHandRubVisible) {
                    hasSymbol = hasSymbol || $('#AfterHandRub').val().length > 0;
                } else {
                    hasSymbol = hasSymbol || $('#AfterHandWash').val().length > 0;
                }

                if (!hasSymbol) {
                    alert('Please select at least one symbol (✓ or X) for any moment.');
                    e.preventDefault();
                }
            });
        });
    </script>
}