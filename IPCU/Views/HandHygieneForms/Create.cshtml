@model IPCU.Models.HandHygieneForm
@{
    ViewData["Title"] = "Create Hand Hygiene Form";
}
<!-- Bootstrap & Font Awesome for Icons -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">

<h2 class="mb-4">Create Hand Hygiene Form</h2>

<form asp-action="Create" method="post" class="needs-validation" novalidate>
    <div asp-validation-summary="ModelOnly" class="text-danger"></div>

    <!-- Hidden Input for HHId -->
    <input asp-for="HHId" type="hidden" />

    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h4 class="mb-0"><i class="fas fa-info-circle me-2"></i>Basic Information</h4>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label asp-for="Area" class="form-label">Area</label>
                    <select asp-for="Area" class="form-select" asp-items="@(ViewBag.StationList as List<SelectListItem>)" required>
                        <option value="">-- Select Area --</option>
                    </select>
                    <span asp-validation-for="Area" class="text-danger"></span>
                </div>

                <div class="col-md-6 mb-3">
                    <label asp-for="Observer" class="form-label">Observer</label>
                    <select asp-for="Observer" class="form-select" required>
                        <option value="">-- Select ICN/Observer --</option>
                        <option value="MVML">MVML</option>
                        <option value="VVR">VVR</option>
                        <option value="ABV">ABV</option>
                        <option value="IPM">IPM</option>
                    </select>
                    <span asp-validation-for="Observer" class="text-danger"></span>
                </div>
            </div>

            <div class="row">
                <div class="col-md-6 mb-3">
                    <label asp-for="Date" class="form-label">Date</label>
                    <input asp-for="Date" type="date" class="form-control" value="@DateTime.Now.ToString("yyyy-MM-dd")" required />
                    <span asp-validation-for="Date" class="text-danger"></span>
                </div>
                <div class="col-md-6 mb-3">
                    <label asp-for="Time" class="form-label">Time</label>
                    <input asp-for="Time" type="time" class="form-control" value="@DateTime.Now.ToString("HH:mm")" required />
                    <span asp-validation-for="Time" class="text-danger"></span>
                </div>
            </div>

            <div class="mb-3">
                <label asp-for="Name" class="form-label">Healthcare Worker Name</label>
                <input asp-for="Name" class="form-control" />
                <span asp-validation-for="Name" class="text-danger"></span>
            </div>

            <div class="mb-3">
                <label class="form-label">Healthcare Worker Type</label>
                <div class="card">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4 mb-2">
                                <div class="form-check">
                                    <input type="radio" class="form-check-input" name="HCWType" id="consultant" value="Consultant" required>
                                    <label class="form-check-label" for="consultant">Consultant</label>
                                </div>
                            </div>
                            <div class="col-md-4 mb-2">
                                <div class="form-check">
                                    <input type="radio" class="form-check-input" name="HCWType" id="fellow" value="Fellow">
                                    <label class="form-check-label" for="fellow">Fellow</label>
                                </div>
                            </div>
                            <div class="col-md-4 mb-2">
                                <div class="form-check">
                                    <input type="radio" class="form-check-input" name="HCWType" id="resident" value="Resident">
                                    <label class="form-check-label" for="resident">Resident</label>
                                </div>
                            </div>
                            <div class="col-md-4 mb-2">
                                <div class="form-check">
                                    <input type="radio" class="form-check-input" name="HCWType" id="nurse" value="Nurse">
                                    <label class="form-check-label" for="nurse">Nurse</label>
                                </div>
                            </div>
                            <div class="col-md-4 mb-2">
                                <div class="form-check">
                                    <input type="radio" class="form-check-input" name="HCWType" id="nursing-attendant" value="Nursing Attendant">
                                    <label class="form-check-label" for="nursing-attendant">Nursing Attendant</label>
                                </div>
                            </div>
                            <div class="col-md-4 mb-2">
                                <div class="form-check">
                                    <input type="radio" class="form-check-input" name="HCWType" id="medical-technologist" value="Medical Technologist">
                                    <label class="form-check-label" for="medical-technologist">Medical Technologist</label>
                                </div>
                            </div>
                            <div class="col-md-4 mb-2">
                                <div class="form-check">
                                    <input type="radio" class="form-check-input" name="HCWType" id="respiratory-therapist" value="Respiratory Therapist">
                                    <label class="form-check-label" for="respiratory-therapist">Respiratory Therapist</label>
                                </div>
                            </div>
                            <div class="col-md-4 mb-2">
                                <div class="form-check">
                                    <input type="radio" class="form-check-input" name="HCWType" id="radiology-staff" value="Radiology Department Staff">
                                    <label class="form-check-label" for="radiology-staff">Radiology Department Staff</label>
                                </div>
                            </div>
                            <div class="col-md-4 mb-2">
                                <div class="form-check">
                                    <input type="radio" class="form-check-input" name="HCWType" id="nursing-aide" value="Nursing Aide">
                                    <label class="form-check-label" for="nursing-aide">Nursing Aide</label>
                                </div>
                            </div>
                            <div class="col-md-12 mb-2">
                                <div class="form-check">
                                    <input type="radio" class="form-check-input" name="HCWType" id="hcw-other" value="Other">
                                    <label class="form-check-label" for="hcw-other">Others:</label>
                                    <input type="text" class="form-control mt-2" id="hcw-other-text" placeholder="Please specify">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <span asp-validation-for="HCWType" class="text-danger"></span>
            </div>

            <div class="mb-3">
                <label class="form-label">Room Type</label>
                <div class="card">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4 mb-2">
                                <div class="form-check">
                                    <input type="radio" class="form-check-input" name="RoomType" id="icu-imcu" value="ICU/IMCU" required>
                                    <label class="form-check-label" for="icu-imcu">ICU/IMCU</label>
                                </div>
                            </div>
                            <div class="col-md-4 mb-2">
                                <div class="form-check">
                                    <input type="radio" class="form-check-input" name="RoomType" id="aiir" value="AIIR">
                                    <label class="form-check-label" for="aiir">AIIR</label>
                                </div>
                            </div>
                            <div class="col-md-4 mb-2">
                                <div class="form-check">
                                    <input type="radio" class="form-check-input" name="RoomType" id="ward" value="Ward">
                                    <label class="form-check-label" for="ward">Ward</label>
                                </div>
                            </div>
                            <div class="col-md-4 mb-2">
                                <div class="form-check">
                                    <input type="radio" class="form-check-input" name="RoomType" id="sigle-room" value="SingleRoom">
                                    <label class="form-check-label" for="sigle-room">Single Room</label>
                                </div>
                            </div>
                            <div class="col-md-4 mb-2">
                                <div class="form-check">
                                    <input type="radio" class="form-check-input" name="RoomType" id="outpatient" value="OutPatient">
                                    <label class="form-check-label" for="outpatient">OutPatient</label>
                                </div>
                            </div>
                            <div class="col-md-12 mb-2">
                                <div class="form-check">
                                    <input type="radio" class="form-check-input" name="RoomType" id="room-other" value="Other">
                                    <label class="form-check-label" for="room-other">Others:</label>
                                    <input type="text" class="form-control mt-2" id="room-other-text" placeholder="Please specify">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <span asp-validation-for="RoomType" class="text-danger"></span>
            </div>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h4 class="mb-0"><i class="fas fa-shield-virus me-2"></i>Isolation Information</h4>
        </div>
        <div class="card-body">
            <div class="mb-3">
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="isolation-toggle" name="Isolation" value="true">
                    <label class="form-check-label" for="isolation-toggle">Isolation Observed?</label>
                    <input type="hidden" name="Isolation" value="false">
                </div>
            </div>

            <div id="isolation-precaution-section" class="mb-3" style="display: none;">
                <label class="form-label">Isolation Precaution</label>
                <div class="card">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3 mb-2">
                                <div class="form-check">
                                    <input type="radio" class="form-check-input isolation-precaution-radio" name="IsolationPrecaution" id="airborne" value="Airborne">
                                    <label class="form-check-label" for="airborne">Airborne</label>
                                </div>
                            </div>
                            <div class="col-md-3 mb-2">
                                <div class="form-check">
                                    <input type="radio" class="form-check-input isolation-precaution-radio" name="IsolationPrecaution" id="droplet" value="Droplet">
                                    <label class="form-check-label" for="droplet">Droplet</label>
                                </div>
                            </div>
                            <div class="col-md-3 mb-2">
                                <div class="form-check">
                                    <input type="radio" class="form-check-input isolation-precaution-radio" name="IsolationPrecaution" id="contact" value="Contact">
                                    <label class="form-check-label" for="contact">Contact</label>
                                </div>
                            </div>
                            <div class="col-md-3 mb-2">
                                <div class="form-check">
                                    <input type="radio" class="form-check-input isolation-precaution-radio" name="IsolationPrecaution" id="protective" value="Protective">
                                    <label class="form-check-label" for="protective">Protective</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <span asp-validation-for="IsolationPrecaution" class="text-danger"></span>
            </div>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h4 class="mb-0"><i class="fas fa-eye me-2"></i>Observation Details</h4>
        </div>
        <div class="card-body">
            <div class="mb-3">
                <label class="form-label">Patient Care Observation</label>
                <div class="card">
                    <div class="card-body">
                        <div class="form-check mb-2">
                            <input type="radio" class="form-check-input" name="ObsvPatientCare" id="direct-observe" value="I can directly observe the patient without any obstruction" required>
                            <label class="form-check-label" for="direct-observe">I can directly observe the patient without any obstruction</label>
                        </div>
                        <div class="form-check mb-2">
                            <input type="radio" class="form-check-input" name="ObsvPatientCare" id="glance-door" value="I can observe only if I glance through a room door">
                            <label class="form-check-label" for="glance-door">I can observe only if I glance through a room door</label>
                        </div>
                        <div class="form-check mb-2">
                            <input type="radio" class="form-check-input" name="ObsvPatientCare" id="window-view" value="There is a large window or glass that allows me to view the activity">
                            <label class="form-check-label" for="window-view">There is a large window or glass that allows me to view the activity</label>
                        </div>
                        <div class="form-check mb-2">
                            <input type="radio" class="form-check-input" name="ObsvPatientCare" id="curtain-parted" value="There is a curtain around the patient. I can see only when the curtain is parted">
                            <label class="form-check-label" for="curtain-parted">There is a curtain around the patient. I can see only when the curtain is parted</label>
                        </div>
                        <div class="form-check mb-2">
                            <input type="radio" class="form-check-input" name="ObsvPatientCare" id="obsv-other" value="Other">
                            <label class="form-check-label" for="obsv-other">Others:</label>
                            <input type="text" class="form-control mt-2" id="obsv-other-text" placeholder="Please specify">
                        </div>
                    </div>
                </div>
                <span asp-validation-for="ObsvPatientCare" class="text-danger"></span>
            </div>

            <div class="mb-3">
                <label class="form-label">Patient Environment Observation</label>
                <div class="card">
                    <div class="card-body">
                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" id="env-observe-toggle" name="ObsvPatientEnvironment">
                            <label class="form-check-label" for="env-observe-toggle">Hand Hygiene Resources Available?</label>
                        </div>

                        <div id="hygiene-resources" style="display: none;">
                            <div class="form-check mb-2">
                                <input type="radio" class="form-check-input environment-resource-radio" name="EnvironmentResource" id="hand-sanitizer" value="Hand sanitizer">
                                <label class="form-check-label" for="hand-sanitizer">Hand sanitizer</label>
                            </div>
                            <div class="form-check mb-2">
                                <input type="radio" class="form-check-input environment-resource-radio" name="EnvironmentResource" id="soap-water" value="Soap and water">
                                <label class="form-check-label" for="soap-water">Soap and water</label>
                            </div>
                        </div>

                        <div id="not-observed" style="display: none;">
                            <div class="form-check mb-2">
                                <input type="checkbox" class="form-check-input" id="not-observed-check" value="Did not observe">
                                <label class="form-check-label" for="not-observed-check">Did not observe</label>
                            </div>
                        </div>
                    </div>
                </div>
                <span asp-validation-for="ObsvPatientEnvironment" class="text-danger"></span>
            </div>

            <!-- TEXTAREA: User input -->
            <div class="mb-3">
                <label asp-for="ObsvPatientContact" class="form-label">Objects HCW Had Contact With</label>
                <textarea asp-for="ObsvPatientContact" class="form-control" rows="3" placeholder="List objects the healthcare worker had contact with in the room before touching the patient"></textarea>
                <span asp-validation-for="ObsvPatientContact" class="text-danger"></span>
            </div>

            <!-- TOGGLE: Not applicable switch -->
            <div class="form-check form-switch mb-3">
                <input class="form-check-input" type="checkbox" id="obj-hcw-toggle">
                <label class="form-check-label" for="obj-hcw-toggle">Not Applicable?</label>
            </div>

            <!-- HIDDEN FIELD: Actual value submitted -->
            <input type="hidden" id="ObsvPatientContactHidden" name="ObsvPatientContact">

        </div>
    </div>

    <div class="d-grid gap-2 d-md-flex justify-content-md-end mb-5">
        <a asp-action="Index" class="btn btn-outline-secondary me-md-2">
            <i class="fas fa-arrow-left me-1"></i> Back to List
        </a>
        <button type="submit" class="btn btn-primary">
            <i class="fas fa-save me-1"></i> Next Form
        </button>
    </div>
</form>

@section Scripts {
    <script>
        // Toggle isolation precaution section visibility
        document.getElementById('isolation-toggle').addEventListener('change', function() {
            const precautionSection = document.getElementById('isolation-precaution-section');
            precautionSection.style.display = this.checked ? 'block' : 'none';

            // Get all radio buttons in the isolation precaution section
            const radioButtons = document.querySelectorAll('.isolation-precaution-radio');

            // Update required attribute based on isolation toggle
            radioButtons.forEach(function(radio) {
                radio.required = this.checked;
            }, this);

            // If isolation is unchecked, reset any selected value
            if (!this.checked) {
                radioButtons.forEach(function(radio) {
                    radio.checked = false;
                });
            }
        });

        // Toggle environment observation sections
        document.getElementById('env-observe-toggle').addEventListener('change', function() {
            document.getElementById('hygiene-resources').style.display = this.checked ? 'block' : 'none';
            document.getElementById('not-observed').style.display = this.checked ? 'none' : 'block';

            // Get all radio buttons in the environment resource section
            const radioButtons = document.querySelectorAll('.environment-resource-radio');

            // Update required attribute based on environment toggle
            radioButtons.forEach(function(radio) {
                radio.required = this.checked;
            }, this);

            // If environment toggle is unchecked, reset any selected value
            if (!this.checked) {
                radioButtons.forEach(function(radio) {
                    radio.checked = false;
                });
            }
        });

        // Handle "Other" options
        document.querySelector('input[id="hcw-other"]').addEventListener('change', function() {
            const otherText = document.getElementById('hcw-other-text');
            otherText.required = this.checked;
            otherText.disabled = !this.checked;
        });

        document.querySelector('input[id="room-other"]').addEventListener('change', function() {
            const otherText = document.getElementById('room-other-text');
            otherText.required = this.checked;
            otherText.disabled = !this.checked;
        });

        document.querySelector('input[id="obsv-other"]').addEventListener('change', function() {
            const otherText = document.getElementById('obsv-other-text');
            otherText.required = this.checked;
            otherText.disabled = !this.checked;
        });

        // Set "Other" text fields as initially disabled
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('hcw-other-text').disabled = true;
            document.getElementById('room-other-text').disabled = true;
            document.getElementById('obsv-other-text').disabled = true;
        });

        //for object hcw toggle
        document.addEventListener('DOMContentLoaded', function () {
            const toggle = document.getElementById('obj-hcw-toggle');
            const textarea = document.querySelector('textarea[name="ObsvPatientContact"]');
            const hiddenInput = document.getElementById('ObsvPatientContactHidden');

            toggle.addEventListener('change', function () {
                if (this.checked) {
                    textarea.disabled = true;
                    textarea.removeAttribute('name');
                    hiddenInput.value = 'Not Applicable';
                } else {
                    textarea.disabled = false;
                    textarea.setAttribute('name', 'ObsvPatientContact');
                    hiddenInput.value = '';
                }
            });
        });


        // Form validation
        (function () {
            'use strict'
            var forms = document.querySelectorAll('.needs-validation')
            Array.prototype.slice.call(forms)
                .forEach(function (form) {
                    form.addEventListener('submit', function (event) {
                        // Custom validation for "Other" fields
                        const hcwOther = document.getElementById('hcw-other');
                        const roomOther = document.getElementById('room-other');
                        const obsvOther = document.getElementById('obsv-other');

                        // Check if isolation precaution is required but not selected
                        const isolationToggle = document.getElementById('isolation-toggle');
                        if (isolationToggle.checked) {
                            const precautionSelected = Array.from(
                                document.querySelectorAll('.isolation-precaution-radio')
                            ).some(radio => radio.checked);

                            if (!precautionSelected) {
                                event.preventDefault();
                                event.stopPropagation();
                                alert('Please select an Isolation Precaution type');
                            }
                        }

                        // Check if environment resource is required but not selected
                        const envObserveToggle = document.getElementById('env-observe-toggle');
                        if (envObserveToggle.checked) {
                            const resourceSelected = Array.from(
                                document.querySelectorAll('.environment-resource-radio')
                            ).some(radio => radio.checked);

                            if (!resourceSelected) {
                                event.preventDefault();
                                event.stopPropagation();
                                alert('Please select a Hand Hygiene Resource type');
                            }
                        }

                        if (hcwOther.checked && !document.getElementById('hcw-other-text').value.trim()) {
                            event.preventDefault();
                            event.stopPropagation();
                            alert('Please specify "Other" HCW Type');
                        }

                        if (roomOther.checked && !document.getElementById('room-other-text').value.trim()) {
                            event.preventDefault();
                            event.stopPropagation();
                            alert('Please specify "Other" Room Type');
                        }

                        if (obsvOther.checked && !document.getElementById('obsv-other-text').value.trim()) {
                            event.preventDefault();
                            event.stopPropagation();
                            alert('Please specify "Other" Observation method');
                        }

                        // Handle ObsvPatientEnvironment and IsolationPrecaution hidden values
                        // These ensure proper value submission when toggles are off

                        // For isolation
                        if (!isolationToggle.checked) {
                            // Create a hidden input to send empty value for IsolationPrecaution
                            const hiddenIsolationInput = document.createElement('input');
                            hiddenIsolationInput.type = 'hidden';
                            hiddenIsolationInput.name = 'IsolationPrecaution';
                            hiddenIsolationInput.value = '';
                            form.appendChild(hiddenIsolationInput);
                        }

                        // For environment observation
                        if (!envObserveToggle.checked) {
                            // Create a hidden input to send the "off" value
                            const hiddenEnvInput = document.createElement('input');
                            hiddenEnvInput.type = 'hidden';
                            hiddenEnvInput.name = 'ObsvPatientEnvironment';
                            hiddenEnvInput.value = 'off';
                            form.appendChild(hiddenEnvInput);

                            // Create a hidden input to send empty value for EnvironmentResource
                            const hiddenResourceInput = document.createElement('input');
                            hiddenResourceInput.type = 'hidden';
                            hiddenResourceInput.name = 'EnvironmentResource';
                            hiddenResourceInput.value = '';
                            form.appendChild(hiddenResourceInput);
                        }

                        // Handle other validations
                        if (!form.checkValidity()) {
                            event.preventDefault();
                            event.stopPropagation();
                        }

                        form.classList.add('was-validated');
                    }, false);
                });
        })();
    </script>
}