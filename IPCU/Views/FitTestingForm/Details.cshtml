@model IPCU.Models.FitTestingForm

@{
    ViewData["Title"] = "Fit Testing Details";

    var validAttempts = new List<IPCU.Models.FitTestingFormHistory?>
{
    ViewData["FirstAttempt"] as IPCU.Models.FitTestingFormHistory,
    ViewData["SecondAttempt"] as IPCU.Models.FitTestingFormHistory,
    ViewData["LastAttempt"] as IPCU.Models.FitTestingFormHistory
}.Where(a => a != null).Distinct().ToList();


    // Helper function for displaying checkmarks and Xs
    Func<bool?, string> displayBoolean = (value) =>
        value.HasValue ? (value.Value ? "✔" : "✖") : "";
}

<!-- Bootstrap & FontAwesome for styling -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">

<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="card shadow-lg border-0">
                <div class="card-header bg-primary text-white text-center">
                    <h3><i class="fa fa-info-circle"></i> Fit Testing Details</h3>
                </div>
                <div class="card-body p-4">

                    <!-- Header Information -->
                    <h4 class="text-center mb-4">Healthcare Worker Information</h4>
                    <table class="table table-bordered">
                        <tbody>
                            <tr>
                                <th><i class="fa fa-user"></i> Name of Healthcare Worker (HCW):</th>
                                <td>@Html.DisplayFor(model => model.HCW_Name)</td>
                            </tr>
                            <tr>
                                <th><i class="fa fa-id-badge"></i> Department/Unit/Office (DUO):</th>
                                <td>@Html.DisplayFor(model => model.DUO)</td>
                            </tr>
                            <tr>
                                <th><i class="fa fa-exclamation-circle"></i> Limitation:</th>
                                <td>@Html.DisplayFor(model => model.Limitation)</td>
                            </tr>
                            <tr>
                                <th><i class="fa fa-user-check"></i> Name of Fit Tester:</th>
                                <td>@Html.DisplayFor(model => model.Name_of_Fit_Tester)</td>
                            </tr>
                            <tr>
                                <th><i class="fa fa-building"></i> DUO of Tester:</th>
                                <td>@Html.DisplayFor(model => model.DUO_Tester)</td>
                            </tr>
                            <tr>
                                <th><i class="fa fa-calendar"></i> Date Submitted:</th>
                                <td>@Model.SubmittedAt.ToString("MMMM dd, yyyy")</td>
                            </tr>
                        </tbody>
                    </table>

                    <h4 class="text-center mt-5 mb-4">Fit Testing Details</h4>

                    <div class="table-responsive">
                        <table class="table table-bordered text-center align-middle">
                            <thead class="bg-light">
                                <tr>
                                    <th>Details</th>
                                    <th>First Attempt</th>
                                    <th>Second Attempt</th>
                                    <th>Third Attempt</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Test Results at the Top -->
                                <tr>
                                    <td>Fit Test Solution</td>
                                    <td>@validAttempts.ElementAtOrDefault(0)?.Fit_Test_Solution</td>
                                    <td>@validAttempts.ElementAtOrDefault(1)?.Fit_Test_Solution</td>
                                    <td>@validAttempts.ElementAtOrDefault(2)?.Fit_Test_Solution</td>
                                </tr>
                                <tr>
                                    <td>Sensitivity Test</td>
                                    <td>@validAttempts.ElementAtOrDefault(0)?.Sensitivity_Test</td>
                                    <td>@validAttempts.ElementAtOrDefault(1)?.Sensitivity_Test</td>
                                    <td>@validAttempts.ElementAtOrDefault(2)?.Sensitivity_Test</td>
                                </tr>
                                <tr>
                                    <td>Respiratory Type</td>
                                    <td>@validAttempts.ElementAtOrDefault(0)?.Respiratory_Type</td>
                                    <td>@validAttempts.ElementAtOrDefault(1)?.Respiratory_Type</td>
                                    <td>@validAttempts.ElementAtOrDefault(2)?.Respiratory_Type</td>
                                </tr>
                                <tr>
                                    <td>Model</td>
                                    <td>@validAttempts.ElementAtOrDefault(0)?.Model</td>
                                    <td>@validAttempts.ElementAtOrDefault(1)?.Model</td>
                                    <td>@validAttempts.ElementAtOrDefault(2)?.Model</td>
                                </tr>
                                <tr>
                                    <td>Size</td>
                                    <td>@validAttempts.ElementAtOrDefault(0)?.Size</td>
                                    <td>@validAttempts.ElementAtOrDefault(1)?.Size</td>
                                    <td>@validAttempts.ElementAtOrDefault(2)?.Size</td>
                                </tr>

                                <!-- Divider Row (Optional for Better Clarity) -->
                                <tr class="table-secondary">
                                    <td colspan="4"><strong>Fit Test Activities</strong></td>
                                </tr>

                                <!-- Fit Test Activities Below -->
                                <tr>
                                    <td>Normal Breathing</td>
                                    <td>@displayBoolean(validAttempts.ElementAtOrDefault(0)?.Normal_Breathing)</td>
                                    <td>@displayBoolean(validAttempts.ElementAtOrDefault(1)?.Normal_Breathing)</td>
                                    <td>@displayBoolean(validAttempts.ElementAtOrDefault(2)?.Normal_Breathing)</td>
                                </tr>
                                <tr>
                                    <td>Deep Breathing</td>
                                    <td>@displayBoolean(validAttempts.ElementAtOrDefault(0)?.Deep_Breathing)</td>
                                    <td>@displayBoolean(validAttempts.ElementAtOrDefault(1)?.Deep_Breathing)</td>
                                    <td>@displayBoolean(validAttempts.ElementAtOrDefault(2)?.Deep_Breathing)</td>
                                </tr>
                                <tr>
                                    <td>Turn Head Side to Side</td>
                                    <td>@displayBoolean(validAttempts.ElementAtOrDefault(0)?.Turn_head_side_to_side)</td>
                                    <td>@displayBoolean(validAttempts.ElementAtOrDefault(1)?.Turn_head_side_to_side)</td>
                                    <td>@displayBoolean(validAttempts.ElementAtOrDefault(2)?.Turn_head_side_to_side)</td>
                                </tr>
                                <tr>
                                    <td>Move Head Up and Down</td>
                                    <td>@displayBoolean(validAttempts.ElementAtOrDefault(0)?.Move_head_up_and_down)</td>
                                    <td>@displayBoolean(validAttempts.ElementAtOrDefault(1)?.Move_head_up_and_down)</td>
                                    <td>@displayBoolean(validAttempts.ElementAtOrDefault(2)?.Move_head_up_and_down)</td>
                                </tr>
                                <tr>
                                    <td>Reading</td>
                                    <td>@displayBoolean(validAttempts.ElementAtOrDefault(0)?.Reading)</td>
                                    <td>@displayBoolean(validAttempts.ElementAtOrDefault(1)?.Reading)</td>
                                    <td>@displayBoolean(validAttempts.ElementAtOrDefault(2)?.Reading)</td>
                                </tr>
                                <tr>
                                    <td>Bending/Jogging</td>
                                    <td>@displayBoolean(validAttempts.ElementAtOrDefault(0)?.Bending_Jogging)</td>
                                    <td>@displayBoolean(validAttempts.ElementAtOrDefault(1)?.Bending_Jogging)</td>
                                    <td>@displayBoolean(validAttempts.ElementAtOrDefault(2)?.Bending_Jogging)</td>
                                </tr>
                                <tr>
                                    <td>Normal Breathing (2)</td>
                                    <td>@displayBoolean(validAttempts.ElementAtOrDefault(0)?.Normal_Breathing_2)</td>
                                    <td>@displayBoolean(validAttempts.ElementAtOrDefault(1)?.Normal_Breathing_2)</td>
                                    <td>@displayBoolean(validAttempts.ElementAtOrDefault(2)?.Normal_Breathing_2)</td>
                                </tr>

                                <!-- Result Row -->
                                <tr>
                                    <td>Result</td>
                                    <td style="color: @(validAttempts.ElementAtOrDefault(0)?.Test_Results == "Failed" ? "red" : "green")">
                                        @validAttempts.ElementAtOrDefault(0)?.Test_Results
                                    </td>
                                    <td style="color: @(validAttempts.ElementAtOrDefault(1)?.Test_Results == "Failed" ? "red" : "green")">
                                        @validAttempts.ElementAtOrDefault(1)?.Test_Results
                                    </td>
                                    <td style="color: @(validAttempts.ElementAtOrDefault(2)?.Test_Results == "Failed" ? "red" : "green")">
                                        @validAttempts.ElementAtOrDefault(2)?.Test_Results
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Navigation Buttons -->
                    <div class="d-flex justify-content-between mt-4">
                        <a asp-action="Index" class="btn btn-secondary"><i class="fa fa-arrow-left"></i> Back</a>
                        <a asp-action="Edit" asp-route-id="@Model?.Id" class="btn btn-warning"><i class="fa fa-edit"></i> Edit</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@if (Model.Test_Results == "Passed")
{
    <div class="text-center mt-4">
        <a asp-action="GeneratePdf" asp-route-id="@Model.Id" class="btn btn-success">
            Send PDF
        </a>
    </div>
}
else if (Model.SubmissionCount < 3)
{
    <div class="text-center mt-4">
        <h5 class="text-muted">
            You have @(3 - Model.SubmissionCount)
            @(3 - Model.SubmissionCount == 1 ? "retake remaining" : "retakes remaining").
        </h5>

        <!-- Retake Button -->
        <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#retakeModal">
            Submit Retake
        </button>
    </div>

    <!-- Retake Modal - LOCKED FIELDS (100% unchanged from yours) -->
    <div class="modal fade" id="retakeModal" tabindex="-1" aria-labelledby="retakeModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="retakeModalLabel">Submit Retake</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form asp-action="SubmitFitTest" method="post">
                        <input type="hidden" name="id" value="@Model.Id" />

                        <input type="hidden" name="Fit_Test_Solution" value="@Model.Fit_Test_Solution" />
                        <input type="hidden" name="Sensitivity_Test" value="@Model.Sensitivity_Test" />
                        <input type="hidden" name="Respiratory_Type" value="@Model.Respiratory_Type" />
                        <input type="hidden" name="Model" value="@Model.Model" />
                        <input type="hidden" name="Size" value="@Model.Size" />

                        <div class="row g-3 mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Fit Test Solution</label>
                                <input type="text" class="form-control" value="@Model.Fit_Test_Solution" disabled />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Sensitivity Test</label>
                                <input type="text" class="form-control" value="@Model.Sensitivity_Test" disabled />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Respiratory Type</label>
                                <input type="text" class="form-control" value="@Model.Respiratory_Type" disabled />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Model</label>
                                <input type="text" class="form-control" value="@Model.Model" disabled />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Size</label>
                                <input type="text" class="form-control" value="@Model.Size" disabled />
                            </div>
                        </div>

                        <hr>

                        <h6 class="fw-bold">Fit Test Activities (check if passed)</h6>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="Normal_Breathing" value="true" />
                                    <label class="form-check-label">Normal Breathing</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="Deep_Breathing" value="true" />
                                    <label class="form-check-label">Deep Breathing</label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="Turn_head_side_to_side" value="true" />
                                    <label class="form-check-label">Turn Head Side to Side</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="Move_head_up_and_down" value="true" />
                                    <label class="form-check-label">Move Head Up and Down</label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="Reading" value="true" />
                                    <label class="form-check-label">Reading</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="Bending_Jogging" value="true" />
                                    <label class="form-check-label">Bending/Jogging</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="Normal_Breathing_2" value="true" />
                                    <label class="form-check-label">Normal Breathing (2)</label>
                                </div>
                            </div>
                        </div>

                        <div class="text-end mt-4">
                            <button type="submit" class="btn btn-primary">Submit Retake</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
}
else
{
    <div class="text-center mt-4">
        <h5 class="text-danger">No retakes remaining.</h5>
        <a asp-action="GeneratePdf" asp-route-id="@Model.Id" class="btn btn-danger mt-3">
            Send PDF
        </a>
    </div>
}
